(()=>{var e;e=jQuery,DokanGeo.LocationsMaps={map:null,mapboxId:"dokan-geolocation-locations-map",items:[],data:{type:"FeatureCollection",features:[]},marker:{image:null,clusterer:null},init:function(){var a=this,o={longitude:0,latitude:0};if(mapboxgl.accessToken=DokanGeo.mapbox_access_token,a.map=new mapboxgl.Map({container:a.mapboxId,style:"mapbox://styles/mapbox/streets-v10",center:[DokanGeo.default_geolocation.longitude,DokanGeo.default_geolocation.latitude],zoom:DokanGeo.map_zoom}),a.map.addControl(new mapboxgl.NavigationControl),a.items=e('[name="dokan_geolocation[]"]'),a.items.each((function(t){e(this).val();var n=e(this).data("latitude"),i=e(this).data("longitude"),r={type:"Feature",properties:{id:"dokan-geolocation-item-"+t,info:e(this).data("info")},geometry:{type:"Point",coordinates:[i,n,0]}};a.data.features.push(r),o.longitude+=i,o.latitude+=n})),o.longitude&&o.latitude)a.map.setCenter([o.longitude/a.items.length,o.latitude/a.items.length]);else{var t=new URLSearchParams(window.location.search),n=Object.fromEntries(t.entries());a.map.setCenter([n.longitude,n.latitude])}a.map.on("load",(function(){a.loadImages("image",DokanGeo.marker.image),a.loadImages("clusterer",DokanGeo.marker.clusterer)}))},loadImages:function(e,a){var o=this;o.map.loadImage(a,(function(a,t){a||(o.marker[e]=t,o.map.addImage("dokan-marker-"+e,t),o.addMapLayers())}))},addMapLayers:function(){var a=this;a.marker.image&&a.marker.clusterer&&(a.map.addSource("dokan_geolocation_map_main_data",{type:"geojson",data:a.data,cluster:!0,clusterMaxZoom:14,clusterRadius:50}),a.map.addLayer({id:"clusters",type:"symbol",source:"dokan_geolocation_map_main_data",filter:["has","point_count"],layout:{"icon-image":"dokan-marker-clusterer","icon-allow-overlap":!0,"text-allow-overlap":!0}}),a.map.addLayer({id:"cluster-count",type:"symbol",source:"dokan_geolocation_map_main_data",filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":["DIN Offc Pro Medium","Arial Unicode MS Bold"],"text-size":12},paint:{"text-color":"rgb(253, 218, 206)"}}),a.map.addLayer({id:"unclustered-point",type:"symbol",source:"dokan_geolocation_map_main_data",filter:["!",["has","point_count"]],layout:{"icon-image":"dokan-marker-image","icon-allow-overlap":!0,"text-allow-overlap":!0}}),a.map.on("click","clusters",(function(o){var t=a.map.queryRenderedFeatures(o.point,{layers:["clusters"]})[0].properties.cluster_id;a.map.getSource("dokan_geolocation_map_main_data").getClusterLeaves(t,255,0,(function(o,n){if(a.map.getZoom()>9&&n.length>1){var i='<div class="white-popup dokan-geo-map-info-windows-in-popup">',r=0;for(r=0;r<n.length;r++)i+=a.getInfoWindowContent(n[r].properties.info);i+="</div>",e.magnificPopup.open({items:{type:"inline",src:i}})}else a.map.getSource("dokan_geolocation_map_main_data").getClusterExpansionZoom(t,(function(e,o){e||a.map.easeTo({center:n[0].geometry.coordinates,zoom:o})}))}))})),a.map.on("mouseenter","clusters",(function(){a.map.getCanvas().style.cursor="pointer"})),a.map.on("mouseleave","clusters",(function(){a.map.getCanvas().style.cursor=""})),a.map.on("click","unclustered-point",(function(e){var o=a.map.queryRenderedFeatures(e.point,{layers:["unclustered-point"]})[0].properties.info;o&&(a.map.easeTo({center:e.lngLat}),new mapboxgl.Popup({closeOnClick:!0}).setLngLat(e.lngLat).setHTML(a.getInfoWindowContent(o)).setMaxWidth("654px").addTo(a.map))})))},getInfoWindowContent:function(e){"string"==typeof e&&(e=JSON.parse(e));var a,o=DokanGeo.info_window_template;for(a in e)o=o.replace("{"+a+"}",e[a]);return o}},e("#dokan-geolocation-locations-map").length&&DokanGeo.mapbox_access_token&&DokanGeo.LocationsMaps.init()})();